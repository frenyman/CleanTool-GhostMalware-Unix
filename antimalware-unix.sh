#!/usr/bin/env bash
####################################################################
# author:    Antonio Orozco R antoniojor@hotmail.com	           #
####################################################################
#©Copyright 2018 Antonio Orozco Ramirez, Todos los derechos reservados bajo licencia GPL V3 https://www.gnu.org/licenses/gpl.html: cualquier modificacion 
#o cambio estructural del script se debe mantener el nombre del primer autor y el print de este.
#cualquier modificacion sobre el print es una violacion a los derechos de autor
#Este programa es software libre: puede redistribuirlo y / o modificar
#     bajo los términos de la Licencia Pública General de GNU publicada por
#     la Free Software Foundation, ya sea la versión 3 de la Licencia, o
#     (a su elección) cualquier versión posterior.

#     Este programa se distribuye con la esperanza de que sea útil,
#     pero SIN NINGUNA GARANTÍA; sin siquiera la garantía implícita de
#     COMERCIABILIDAD o IDONEIDAD PARA UN PROPÓSITO PARTICULAR. Ver el
#     Licencia pública general de GNU para más detalles.

#     Deberías haber recibido una copia de la Licencia Pública General de GNU
#     junto con este programa. De lo contrario, consulte <http://www.gnu.org/licenses/>
#
# Se autoriza toda copia y distribucion de este script siempre y cuando se mantenga los términos de la Licencia Pública General de GNU (GPL V3)
#### presentacion principal ####
#ASCII
echo -e "\e[97m======================================================================================================="	
echo " Script Desarrollado para la erradicacion de powerghost en maquinas Unix"
echo "======================================================================================================="
echo "   _____  _____  ____   _____                   _   _       _               _"
echo "  / ____|/ ____|/ __ \ / ____|      /\         | | (_)     | |             | |"
echo " | |    | (___ | |  | | |   ______ /  \   _ __ | |_ _| __ _| |__   ___  ___| |_" 
echo " | |     \___ \| |  | | |  |______/ /\ \ |  _ \| __| |/  _  | _ \ / _ \/ __| __|"
echo " | |____ ____) | |__| | |____    / ____ \| | | | |_| | (_| | | | | (_) \__ \ |_ "
echo "  \_____|_____/ \____/ \_____|  /_/    \_\_| |_|\__|_|\__, |_| |_|\___/|___/\__|"
echo "                                                       __/ |                    "
echo "                                                      |___/             "
date
echo -e "=======================================================================================================\e[0m"
#Limpiando
echo "limpiando ........."
#variables del malware
DownloadPath="/usr/lib/..."
ShellProceName="diskmanagerd"
soddProceName="kacpi_notify"
shell_privilege=1
OsType=1
verify_method="md5sum"
ShellArg=$1
Ver=1.0
initPath="/etc/rc.d"
PxeName="pxe.c"
#===============================================
#añadir LOGS ANTES
#===============================================
ls -la /proc/ |grep "exe" > /opt/log_exe_antes
ls -la /tmp/  > /opt/log_tmp_antes
ls -la /usr/lib/.../ > /opt/log_usr_antes
ls -la /etc/cron.hourly/ > /opt/log_cron_antes
ls -la /etc/rcS.d/ > /opt/log_rcs.d_antes
ls -la $initPath/init.d/ > /opt/log_init_antes
#===============================================
if [ "$ShellArg" != "/sbin/init" ]; then
    rm -f $DownloadPath/$ShellProceName >/dev/null 2>&1
    rm -f $0
    cd $DownloadPath
else
    if [ -f "/tmp/.../.d1r7y.txt" ]; then
        ps -ef | grep '/tmp/.../pxe' | grep -vw grep | awk '{ print $2 }' | xargs kill -9
        rm -f /tmp/.../just4run
        rm -f /tmp/.../pxe
        rm -f /tmp/.../pxe.c
        rm -f /tmp/.../.d1r7y.txt
    fi
fi
##############################################################################################################
# 											LIMPIEZA TOTAL DEL MALWARE										 #
##############################################################################################################
#Elimino el cron
rm -rf /etc/cron.hourly/gcc4lef.sh
#elimino proceso
rm -rf $DownloadPath/$ShellProceName >/dev/null 2>&1
rm -rf $initPath/init.d/$ShellProceName
rm -rf $initPath/init.d/$soddProceName
rm -rf /etc/rcS.d/S90$ShellProceName
rm -f $DownloadPath/$soddProceName
###ELIMINADO LOS PROCESOS####
echo -e "=======================================================================================================\e[0m"
echo -e "					ELIMINADO LOS SERVICIOS																\e[0m"
echo -e "=======================================================================================================\e[0m"
update-rc.d -f $ShellProceName remove
update-rc.d -f $soddProceName remove
#otros archivos
rm -rf /lib/libterminfo.so
rm -rf $DownloadPath/httpdinfo
rm -rf /usr/lib/.../httpdinfo
rm -f /tmp/.../just4run
rm -f /tmp/.../pxe
rm -f /tmp/.../pxe.c
rm -f /tmp/.../.d1r7y.txt
rm -f /tmp/.../brootkit.sh
rm -f /tmp/.../install.sh
#limpio carpeta temporal
echo -e "=======================================================================================================\e[0m"
echo -e "					ELIMINADO LOS TEMPORALES															\e[0m"
echo -e "=======================================================================================================\e[0m"
echo "Limpiando temporal..."
rm -vfr /tmp/* >/dev/null 2>&1 && rm -vfr /var/tmp/* >/dev/null 2>&1
rm -f /tmp/.h
rm -rf /tmp/.helpdd
rm -rf /tmp/.../pxe
rm -rf /tmp/.../just4run
rm -rf /tmp/.../$PxeName
echo "done"
#limpiar botnet
echo -e "=======================================================================================================\e[0m"
echo -e "				LIMPIANDO BOTNET BILLGATES																\e[0m"
echo -e "=======================================================================================================\e[0m"
#ps -ef | grep -w '.sshd' | grep -vw grep | awk '{ print $2 }' | xargs kill -9
rm -rf  /tmp/moni.lod /tmp/gates.lod > /dev/null 2>&1
rm -rf  /etc/init.d/selinux  /etc/init.d/DbSecuritySpt > /dev/null 2>&1
rm -rf  /etc/rc1.d/S97DbSecuritySpt  /etc/rc1.d/S99selinux > /dev/null 2>&1
rm -rf  /etc/rc2.d/S97DbSecuritySpt  /etc/rc2.d/S99selinux > /dev/null 2>&1
rm -rf  /etc/rc3.d/S97DbSecuritySpt  /etc/rc3.d/S99selinux > /dev/null 2>&1
rm -rf  /etc/rc4.d/S97DbSecuritySpt  /etc/rc4.d/S99selinux > /dev/null 2>&1
rm -rf  /etc/rc5.d/S97DbSecuritySpt  /etc/rc5.d/S99selinux > /dev/null 2>&1
rm -rf  /usr/bin/bsd-port/conf.n  > /dev/null 2>&1
rm -rf  /usr/bin/bsd-port/getty > /dev/null 2>&1
rm -rf  /usr/bin/bsd-port/getty.lock > /dev/null 2>&1
rm -rf  /tmp/pythompy > /dev/null 2>&1
echo -e "LIMPIEZA COMPLETADA \e[0m"
echo -e "=======================================================================================================\e[0m"
echo -e "					SCREENSHOT DEL MALWARE	(Cron)														\e[0m"
echo -e "=======================================================================================================\e[0m"
cat /opt/log_cron_antes
echo -e "=======================================================================================================\e[0m"
echo -e "					SCREENSHOT DEL MALWARE	(EXE)														\e[0m"
echo -e "=======================================================================================================\e[0m"
cat /opt/log_exe_antes
echo -e "=======================================================================================================\e[0m"
echo -e "					SCREENSHOT DEL MALWARE	(TMP)														\e[0m"
echo -e "=======================================================================================================\e[0m"
cat /opt/log_tmp_antes
echo -e "=======================================================================================================\e[0m"
echo -e "					SCREENSHOT DEL MALWARE	(USR)														\e[0m"
echo -e "=======================================================================================================\e[0m"
cat /opt/log_usr_antes
echo -e "=======================================================================================================\e[0m"
echo -e "					SCREENSHOT DEL MALWARE	(rcs)														\e[0m"
echo -e "=======================================================================================================\e[0m"
cat /opt/log_rcs.d_antes
echo -e "=======================================================================================================\e[0m"
echo -e "					SCREENSHOT DEL MALWARE	(init)														\e[0m"
echo -e "=======================================================================================================\e[0m"
cat /opt/log_init_antes